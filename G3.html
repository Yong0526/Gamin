<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>第三关 - 手机跑酷</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  text-align: center;
  background: #87CEFA;
  overflow: hidden;
}
#score { font-size: 18px; margin: 10px; font-weight: bold; }
#progressContainer {
  width: 90%;
  height: 20px;
  background: rgba(255,255,255,0.3);
  border-radius: 10px;
  margin: 0 auto 10px auto;
}
#progressBar { width: 0%; height: 100%; background: #ffcc00; border-radius: 10px; }
#gameCanvas {
  border: 2px solid #0073b3;
  background: #fff;
  display: block;
  margin: 0 auto;
  border-radius: 10px;
  touch-action: none; /* 手机触控 */
}
#jumpBtn, #restartBtn {
  position: fixed;
  bottom: 20px;
  font-size: 22px;
  padding: 15px 30px;
  background: #0073b3;
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  z-index: 10;
}
#jumpBtn:active, #restartBtn:active { background: #005f8a; }
#jumpBtn { left: 20%; }
#restartBtn { right: 20%; }
</style>
</head>
<body>
<h2>第三关 - 跑酷小游戏</h2>
<div id="score">进度: 0 / 3</div>
<div id="progressContainer"><div id="progressBar"></div></div>
<canvas id="gameCanvas" width="360" height="400"></canvas>
<button id="jumpBtn">跳跃</button>
<button id="restartBtn">重新开始</button>

<!-- 音效 -->
<audio id="scoreSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_0d16f9f8f8.mp3?filename=correct-6248.mp3"></audio>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// 玩家
let player = { x: 50, y: 350, width: 40, height: 40, dy: 0, jumpPower: -14, gravity: 0.6, flash: 0 };

// 障碍物
let obstacles = [];
let frame = 0;
let score = 0;
const target = 3;
let gameOver = false;

// 音效
const scoreSound = document.getElementById("scoreSound");

// 跳跃
function jump() { if(player.y >= 350) player.dy = player.jumpPower; }

// 初始化
function initGame() {
  player.y = 350; player.dy = 0; player.flash = 0;
  obstacles = []; frame = 0; score = 0; gameOver = false;
  document.getElementById("score").innerText = `进度: ${score} / ${target}`;
  document.getElementById("progressBar").style.width = '0%';
  update();
}

// 绘制玩家
function drawPlayer(){
  ctx.fillStyle = player.flash>0 ? "#ffff00" : "red";
  ctx.fillRect(player.x, player.y, player.width, player.height);
  if(player.flash>0) player.flash--;
}

// 绘制障碍物
function drawObstacles(){
  obstacles.forEach(ob=>{
    ctx.fillStyle = ob.flash>0 ? "#FFD700" : "green";
    ctx.fillRect(ob.x, ob.y - (ob.flash>0?5:0), ob.width, ob.height);
    if(ob.flash>0) ob.flash--;
  });
}

// 绘制地面
function drawGround(){ ctx.fillStyle = "#228B22"; ctx.fillRect(0, 380, canvas.width, 20); }

// 更新跳跃
function updateJump(){
  player.y += player.dy;
  player.dy += player.gravity;
  if(player.y > 350) player.y = 350;
}

// 更新障碍物
function updateObstacles(){
  obstacles.forEach((ob,index)=>{
    ob.x -= 2;
    if(player.x < ob.x+ob.width && player.x+player.width>ob.x &&
       player.y<ob.y+ob.height && player.y+player.height>ob.y){
         gameOver = true;
         setTimeout(()=> alert("游戏失败！请点击重新开始"),100);
    }
    if(ob.x + ob.width < 0){
      obstacles.splice(index,1);
      score++;
      player.flash = 5;
      ob.flash = 5;
      scoreSound.currentTime = 0;
      scoreSound.play();
      document.getElementById("score").innerText = `进度: ${score} / ${target}`;
      document.getElementById("progressBar").style.width = `${(score/target)*100}%`;
      if(score>=target){
        gameOver = true;
        setTimeout(()=>{ alert("恭喜过关！进入第四关"); window.location.href="G4.html"; },100);
      }
    }
  });
}

// 游戏循环
function update(){
  if(gameOver) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  frame++;

  drawGround();
  updateJump();

  if(frame % 180 === 0){ obstacles.push({x:canvas.width, y:350, width:30, height:40, flash:0}); }

  updateObstacles();
  drawPlayer();
  drawObstacles();

  requestAnimationFrame(update);
}

// 绑定按钮
document.getElementById("jumpBtn").addEventListener("click", jump);
document.getElementById("restartBtn").addEventListener("click", initGame);
canvas.addEventListener("touchstart", jump);
canvas.addEventListener("mousedown", jump);

initGame();
</script>
</body>
</html>

